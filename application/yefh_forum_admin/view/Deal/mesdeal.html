<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta http-equiv="X-UA-Compatible" content="ie=edge">
  <title>帖子管理</title>
  <link rel="stylesheet" href="__CSS__/reset.css">
  <link rel="stylesheet" href="__STATIC__/common/layui/css/layui.css" media="all">
  <link rel="stylesheet/less" href="__CSS__/admin/nav.less">
  <link rel="stylesheet/less" href="__CSS__/admin/table.less">
  <link rel="stylesheet" href="__STATIC__/common/layui/css/layui.css" media="all">
  <script src="__CSS__/admin/less.js"></script>
</head>

<body>
  <div class="topNav">
    <span class="top-icon"></span>
    <span class="top-logo">DaHeiShuai</span>
    <a class="top-logout" href="{:url('yefh_forum_admin/admin/aLogout')}">注销</a>
  </div>
  <div class="sideNav">
    <div class="side-avatar">
      <img src="__STATIC__/upload/avatar/猫咪头像.jpg" alt="">
    </div>
    <div class="side-username">
      大黑帅
    </div>
    <ul class="side-action">
      <li>
        <a href="{:url('yefh_forum_admin/deal/index')}">
          <span class="layui-icon layui-icon-chart"></span>
          <span>首页</span>
        </a>
      </li>
      <li class="side-active">
        <a href="{:url('yefh_forum_admin/deal/mesdeal')}">
          <span class="layui-icon layui-icon-tabs"></span>
          <span>帖子管理</span>
        </a>
      </li>
      <li>
        <a href="{:url('yefh_forum_admin/deal/userdeal')}">
          <span class="layui-icon layui-icon-user"></span>
          <span>用户管理</span>
        </a>
      </li>
      <li>
        <a href="{:url('yefh_forum_admin/deal/sectiondeal')}">
          <span class="layui-icon layui-icon-template-1"></span>
          <span>模板管理</span>
        </a>
      </li>
      <li>
        <a href="{:url('yefh_forum_admin/deal/recycledeal')}">
          <span class="layui-icon layui-icon-delete"></span>
          <span>回收站管理</span>
        </a>
      </li>
      <li>
        <a href="{:url('yefh_forum_admin/advdeal/ad')}">
          <span class="layui-icon layui-icon-website"></span>
          <span>广告管理</span>
        </a>
      </li>
      <li>
        <a href="{:url('yefh_forum_admin/advdeal/slidedeal')}">
          <span class="layui-icon layui-icon-picture"></span>
          <span>轮播图管理</span>
        </a>
      </li>
      <li>
        <a href="{:url('yefh_forum_admin/admin/apa')}">
          <span class="layui-icon layui-icon-face-smile-b"></span>
          <span>我的</span>
        </a>
      </li>
      <li>
        <a href="{:url('yefh_forum_admin/deal/reception')}">
          <span class="layui-icon layui-icon-fonts-html"></span>
          <span>论坛前台</span>
        </a>
      </li>
    </ul>
  </div>
  <div class="content">
    <div class="mes-title">
      <fieldset class="layui-elem-field layui-field-title" style="margin-top: 30px;">
        <legend>当前板块：<span data-cursid="<?php echo $section[0]['sid']; ?>"
            class="mes-current"><?php echo $section[0]['sname']; ?></span></legend>
      </fieldset>
      <div class="layui-tab">
        <ul class="layui-tab-title">
          <?php foreach ($section as $item => $info): ?>
          <li class="<?php echo $item == 0 ? 'layui-this' : '' ?>" data-sid="<?php echo $info['sid'] ?>">
            <?php echo $info['sname'] ?></li>
          <?php endforeach ?>
        </ul>
      </div>
    </div>
    <div class="mes-content">
      <table class="table">
        <!-- Replace "table" with any of the design numbers -->
        <thead>
          <th>帖子编号</th>
          <th>标题</th>
          <th>发布时间</th>
          <th>作者</th>
          <th>操作</th>
        </thead>
        <tbody>
          <!-- 数据 -->
        </tbody>
      </table>
    </div>
  </div>
</body>

<script src="__STATIC__/common/layui/layui.js" charset="utf-8"></script>
<script src="__STATIC__/common/jquery/jquery.js" charset="utf-8"></script>

<!-- 注意：如果你直接复制所有代码到本地，上述js路径需要改成你本地的 -->
<script>
  $(function () {
    layui.use('element', function () {
      var $ = layui.jquery
        , element = layui.element; //Tab的切换功能，切换事件监听等，需要依赖element模块
      $('.site-demo-active').on('click', function () {
        var othis = $(this), type = othis.data('type');
      });
    });


    // 获取表格元素
    let $tbody = $(".table tbody");
    // 获取板块选择元素
    let $seleLi = $(".layui-tab-title li");
    // 首次获取第一个板块数据
    getData($tbody);
    $seleLi.on('click', (e) => {
      let $target = $(e.target)
      let $sid = $target.data('sid')
      $('.mes-current').html($target.html()).data('cursid', $sid)
      getData($tbody, $sid)
    })
    // 跳转到编辑页
    $('body').on('click', '.edit', function (e) {
      let mid = $(e.target).parents('td').siblings('td').html();
      $(location).attr('href', `resdeal?mid=${mid}`)
    })
    // 删除帖子
    $('body').on('click', '.del', function (e) {
      let $mid = $(e.target).parents('td').siblings('td').html();
      deles($mid)
    })
  })

  // 已进入页面先加载第一个板块的数据
  function getData(tarEle, sid = 1) {
    tarEle.children().remove()
    $.ajax({
      type: "get",
      url: "showmes",
      data: { 'sid': sid },
      dataType: "json",
      success: function (res) {
        res.forEach((item, index) => {
          tarEle.append(`
            <tr>
              <td data-mid="${item.id}">${item.mid}</td>
              <td>${item.mtitle}</td>
              <td>${new Date(item.mcreateat * 1000).toLocaleString()}</td>
              <td>${item.unick}</td>
              <td>
                <button type="button" class="edit layui-btn layui-btn-normal layui-btn-sm">编辑</button>
                <button type="button" class="del layui-btn layui-btn-danger layui-btn-sm">删除</button>
              </td>
            </tr>
          `)
        });
      }
    });
  }

  function deles(mid) {
    $.ajax({
      type: "get",
      url: "delmes",
      data: { "mid": mid },
      dataType: "json",
      success: function (response) {
        if (response.success == 1) {
          let cursid = $('.mes-current').data('cursid')
          getData($(".table tbody"), cursid)
        } else {
          alert("删除失败")
        }
      },
      error: function () {
        alert("服务器出错")
      }
    });
  }
</script>

</html>