<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta http-equiv="X-UA-Compatible" content="ie=edge">
  <title>帖子回收站管理</title>
  <link rel="stylesheet" href="__CSS__/reset.css">
  <link rel="stylesheet" href="__STATIC__/common/layui/css/layui.css" media="all">
  <link rel="stylesheet" href="__STATIC__/common/toast/toast.css" media="all">
  <link rel="stylesheet" href="__CSS__/admin/nav.css">
  <link rel="stylesheet" href="__CSS__/admin/table.css">
  <link rel="stylesheet" href="__CSS__/admin/binsec.css">
</head>

<body>
  <div class="topNav">
    <span class="top-icon"></span>
    <span class="top-logo">DaHeiShuai</span>
    <a class="top-logout" href="{:url('yefh_forum_admin/admin/aLogout')}">注销</a>
  </div>
  <div class="sideNav">
    <div class="side-avatar">
      <img src="__STATIC__/upload/avatar/猫咪头像.jpg" alt="">
    </div>
    <div class="side-username">
      {$Think.session.user}
    </div>
    <ul class="side-action">
      <li>
        <a href="{:url('yefh_forum_admin/deal/index')}">
          <span class="layui-icon layui-icon-chart"></span>
          <span>首页</span>
        </a>
      </li>
      <li>
        <a href="{:url('yefh_forum_admin/deal/mesdeal')}">
          <span class="layui-icon layui-icon-tabs"></span>
          <span>帖子管理</span>
        </a>
      </li>
      <li>
        <a href="{:url('yefh_forum_admin/deal/userdeal')}">
          <span class="layui-icon layui-icon-user"></span>
          <span>用户管理</span>
        </a>
      </li>
      <li>
        <a href="{:url('yefh_forum_admin/deal/sectiondeal')}">
          <span class="layui-icon layui-icon-template-1"></span>
          <span>模板管理</span>
        </a>
      </li>
      <li class="side-active">
        <a href="{:url('yefh_forum_admin/bindeal/binsec')}">
          <span class="layui-icon layui-icon-delete"></span>
          <span>回收站管理</span>
        </a>
      </li>
      <li>
        <a href="{:url('yefh_forum_admin/advdeal/ad')}">
          <span class="layui-icon layui-icon-website"></span>
          <span>广告管理</span>
        </a>
      </li>
      <li>
        <a href="{:url('yefh_forum_admin/advdeal/slidedeal')}">
          <span class="layui-icon layui-icon-picture"></span>
          <span>轮播图管理</span>
        </a>
      </li>
      <li>
        <a href="{:url('yefh_forum_admin/admin/apa')}">
          <span class="layui-icon layui-icon-face-smile-b"></span>
          <span>我的</span>
        </a>
      </li>
      <li>
        <a href="{:url('yefh_forum/index/index')}">
          <span class="layui-icon layui-icon-fonts-html"></span>
          <span>论坛前台</span>
        </a>
      </li>
    </ul>
  </div>
  <div class="content">
    <h1 class="title">回收站</h1>
    <div class="select-box">
      <select onchange="window.location=this.value">
        <option value="{:url('yefh_forum_admin/bindeal/binsec')}">板块回收站管理</option>
        <option value="{:url('yefh_forum_admin/bindeal/binmes')}" selected="">帖子回收站管理</option>
        <option value="{:url('yefh_forum_admin/bindeal/binres')}">回复回收站管理</option>
      </select>
    </div>
    <div class="select-box">
      <select class="section-box">
        <option disabled="disabled" value="" selected="">选择板块</option>
        {volist name="section" id='item'}
        <option value="{$item.sid}">{$item.sname}</option>
        {/volist}
      </select>
    </div>
    <table class="table">
      <!-- Replace "table" with any of the design numbers -->
      <thead>
        <th>mid</th>
        <th>标题</th>
        <th>发布时间</th>
        <th>作者</th>
        <th>放入回收站时间</th>
        <th>操作</th>
        <th>放入回收站原因</th>
      </thead>
      <tbody class="tbody">
        <!-- 数据 -->
      </tbody>
    </table>
  </div>
</body>
<script src="__STATIC__/common/layui/layui.js" charset="utf-8"></script>
<script src="__STATIC__/common/jquery/jquery.js" charset="utf-8"></script>
<script src="__STATIC__/common/toast/toast.js" charset="utf-8"></script>

<script>
  $(function () {
    layui.use('form', function () {
    });
    let $tbody = $('.tbody')
    let $sid = 0
    let $delBtn = $('.delBtn')
    let toast = new Toast()
    // 筛选帖子
    $('.section-box').on('change', function (e) {
      $sid = $(this).val();
      getMesdata($sid);
    })
    // 还原帖子
    $('body').on('click', '.backBtn', function (e) {
      $mid = $(this).parents('tr').find('.mid').html()
      $tr = $(e.target).parents("tr")
      backMes($tr, $mid);
    })
    // 彻底删除功能
    $('body').on('click', '.delBtn', function (e) {
      $mid = $(this).parents('tr').find('.mid').html()
      $tr = $(this).parents('tr')
      $.ajax({
        type: "post",
        url: "delmes",
        data: { 'mid': $mid },
        dataType: "JSON",
        success: function (res) {
          console.log(res);
          if (res.success == 1) {
            toast.success('彻底删除成功！')
            $tr.remove()
          }
        }
      });
    })
    // 筛选帖子
    function getMesdata(sid) {
      $.ajax({
        type: "post",
        url: "secmes",
        data: { 'sid': sid },
        dataType: "JSON",
        success: function (res) {
          $tbody.children().remove()
          if (res.success == 1) {
            res.mesLs.forEach(item => {
              $tbody.append(`<tr>
                <td class="mid">${item.mid}</td>
                <td>${item.mtitle}</td>
                <td>${new Date(item.mcreateat * 1000).toLocaleString()}</td>
                <td>${item.unick}</td>
                <td>${new Date(item.mdelat * 1000).toLocaleString()}</td>
                <td>
                  <button class="delBtn layui-btn layui-btn-danger layui-btn-sm" data-sid="" href="">彻底删除</button>
                  ${item.mbin > 1 ? '<button class="backBtn layui-btn layui-btn-primary layui-btn-sm" data-sid="" href="">还原</button>' : ''}
                </td>
                <td>${filterMbin(item.mbin)}</td>
              </tr>`)
            });
          }
        }
      });
    }
    function filterMbin(mbin) {
      if (mbin == 1) {
        return '删除板块'
      } else {
        return '删除帖子'
      }
    }
    // 还原帖子
    function backMes(tr, mid) {
      $.ajax({
        type: "post",
        url: "backMes",
        data: { 'mid': mid },
        dataType: "JSON",
        success: function (res) {
          if (res.success == 1) {
            toast.success("还原成功！")
            tr.remove()
          }
        }
      });
    }
  })

</script>

</html>